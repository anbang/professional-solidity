# 15.ç®—æ³•

æ­¤ç®—æ³•å‚è€ƒæˆ‘ä¹‹å‰å†™çš„[JS æ•™ç¨‹ç®—æ³•](https://github.com/anbang/javascript-notes/blob/8912f7efb4456064456079caa5fdfc573e0109bd/JS%E7%AE%97%E6%B3%95%E5%8E%9F%E7%90%86/JS%E4%B8%AD%E7%9A%84%E5%B8%B8%E8%A7%81%E7%AE%97%E6%B3%95.md),ç„¶ååšæ”¹åŠ¨ã€‚

åœ¨ Solidity å†…ä¸»è¦æ˜¯ç»æµæ¨¡å‹çš„ç®—æ³•ï¼Œåœ¨å…¶ä»–è¯­è¨€å†…çš„å„ç§æ’åºç®—æ³•ï¼Œåœ¨åˆçº¦å†…ä½¿ç”¨åœºæ™¯å¹¶ä¸æ˜¯å¾ˆå¸¸è§ï¼Œä¹‹æ‰€ä»¥åœ¨è¿™é‡Œç½—åˆ—ï¼Œæ˜¯ä¸€èµ·ç†Ÿæ‚‰ä¸‹æ€è·¯ï¼Œç®—æ³•æ˜¯å¾ˆåŸºç¡€çš„é€»è¾‘è®­ç»ƒé€”å¾„ï¼Œä¸‹é¢ä»…ä»¥æ’å…¥æ’åºå–å†’æ³¡æ’åºä½œä¸ºä¾‹å­ã€‚å¿«é€Ÿæ’åºå’Œæ•°ç»„å»é‡ä½œä¸ºæ‰©å±•ç»ƒä¹ 

## 1ï¸âƒ£ æ’å…¥æ’åº

æ’å…¥æ’åºæ˜¯ä¸€ç§æœ€ç®€å•ç›´è§‚çš„æ’åºç®—æ³•ï¼Œå®ƒçš„å·¥ä½œåŸç†æ˜¯é€šè¿‡æ„å»ºæœ‰åºåºåˆ—ï¼Œå¯¹äºæœªæ’åºæ•°æ®ï¼Œåœ¨å·²æ’åºåºåˆ—ä¸­ä»åå‘å‰æ‰«æï¼Œæ‰¾åˆ°ç›¸åº”ä½ç½®å¹¶æ’å…¥ã€‚

æ“ä½œæ­¥éª¤ï¼šé¦–å…ˆé€‰å–æ•°ç»„çš„ç¬¬ä¸€é¡¹å³ `ary[0]`ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºè¿™ä¸ªæ•°æ˜¯å·²ç»å®‰æ’å¥½åºçš„ï¼Œå†å– `ary[1]`é¡¹æ’å…¥åˆ°å·²ç»æ’å¥½åºçš„å…ƒç´ ä¸­ï¼Œæ­¤æ—¶åªæœ‰ `ary[0]`ï¼Œæˆ‘ä»¬æ¯”è¾ƒ` ary[0]`å’Œ `ary[1]`ï¼›å¤§äº `ary[0]`å°±æ”¾åœ¨åé¢ï¼Œå°äºå°±æ’åˆ° `ary[0]` å‰é¢ï¼›è¦æ’å…¥çš„å…ƒç´ ä¾æ¬¡ä¸º` ary[1]`è‡³` ary[ary.leng-1]`é¡¹ï¼›æ’å…¥åˆ°æ’åºå¥½çš„æ•°ç»„ä¸­çš„æ—¶å€™ï¼Œæ’å…¥æ¯ä¸€é¡¹éƒ½éœ€è¦ä»åé¢å¾€å‰é¢éå†å·²ç»æ’åºå¥½çš„å…ƒç´ ï¼›

å¦‚æœæ’åºå¥½çš„å…ƒç´ æ¯”æ’å…¥çš„å…ƒç´ å¤§ï¼Œåˆ™æŠŠè¯¥å…ƒç´ å¾€åæŒªä¸€ä½ï¼Œç›´åˆ°å·²ç»æ’åºçš„å…ƒç´ å°äºç­‰äºè¦æ’å…¥çš„å…ƒç´ ï¼ˆæˆ–è€…å·²ç»éå†å®Œå·²ç»æ’å¥½åºçš„æ•°ç»„é¡¹ï¼‰ï¼Œåˆ™æŠŠè¦æ’å…¥çš„å…ƒç´ æ”¾åœ¨è¯¥ä½ç½®+1 çš„ç´¢å¼•ä½ç½®ä¸­ï¼ˆåå‘æ’çš„æ—¶å€™ï¼Œéœ€è¦æ”¾åœ¨æ•°ç»„çš„ç¬¬ 0 ä¸ªä½ç½®ï¼‰ï¼Œå¯¹æ¯ä¸ªæ’å…¥çš„å…ƒç´ éƒ½æ‰§è¡Œä¸Šé¢çš„æ“ä½œï¼Œæœ€ç»ˆæ•°ç»„å°±æ˜¯æ’åºå¥½çš„ï¼›

### é”™è¯¯ç‰ˆæœ¬

æŠŠåŸæ¥ [JS ç®—æ³•](https://github.com/anbang/javascript-notes/blob/8912f7efb4456064456079caa5fdfc573e0109bd/JS%E7%AE%97%E6%B3%95%E5%8E%9F%E7%90%86/JS%E4%B8%AD%E7%9A%84%E5%B8%B8%E8%A7%81%E7%AE%97%E6%B3%95.md#%E6%8F%92%E5%85%A5%E6%8E%92%E5%BA%8F) é‡Œå†™çš„ä»£ç æ‹·è´è¿›æ¥ä¿®æ”¹åï¼Œç«Ÿç„¶é”™äº†ã€‚

```
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.17;

// [11,2,31,45,6,78,37,33,21] => [2, 6, 11, 21, 31, 33, 37, 45, 78]
contract Demo {
    function insertSort(uint256[] memory ary)
        public
        pure
        returns (uint256[] memory)
    {
        uint256 temp; //å®šä¹‰ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œä¿å­˜è¦æ’å…¥çš„å€¼ï¼›
        uint256 len = ary.length;
        for (uint256 i = 1; i < len; i++) {
            if (ary[i] < ary[i - 1]) {
                temp = ary[i]; //éœ€è¦æ’å…¥çš„å€¼ï¼›
                uint256 pIndex = i - 1; //éœ€è¦æ’å…¥å€¼çš„å‰ä¸€ä¸ªç´¢å¼•ï¼›
                while (temp < ary[pIndex] && pIndex >= 0) {
                    ary[pIndex + 1] = ary[pIndex]; //ç›¸å½“äºary[i]=ary[i-1];
                    ary[pIndex] = temp; //ç›¸å½“äºary[i-1]=temp;å®Œæˆä¸€æ³¢äº¤æ¢ï¼›
                    pIndex--; //å‡†å¤‡ä¸‹ä¸€æ³¢äº¤æ¢ï¼›
                }
            }
        }
        return ary;
    }
}
```

æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼šå‡ºç°äº† `overflow`äº†ã€‚

```
{
	"error": "Failed to decode output: Error: overflow (fault=\"overflow\", operation=\"toNumber\", value=\"35408467139433450592217433187231851964531694900788300625387963629091585785856\", code=NUMERIC_FAULT, version=bignumber/5.5.0)"
}
```

è¿™ä¸ªä»£è¡¨è¶…å‡ºäº† `uint256`çš„èŒƒå›´äº†ï¼Œ`uint256` çš„èŒƒå›´æ˜¯ `0` è‡³`115792089237316195423570985008687907853269984665640564039457584007913129639935`ï¼Œè‚¯å®šä¸æ˜¯è¿ç®—è¶…å‡ºæœ€å¤§å€¼äº†ï¼Œåªèƒ½æ˜¯è®¡ç®—æ—¶å€™è¶…å‡ºæœ€å°å€¼äº†ï¼›åŸºæœ¬å¯ä»¥é”å®š `pIndex--;` è¿™ä¸€å¥å¯¼è‡´çš„é”™è¯¯ï¼Œè¿è¡Œåˆ° `0--` ç­‰äº -1 ï¼Œå¯¼è‡´å‡ºé”™äº†ã€‚

### ä¿®å¤å¦‚ä¸‹

åŸç†: åªéœ€è¦è®© `pIndex--` æœ€å°è¿è¡Œåˆ° `1--` å°±å¯ä»¥è§£å†³æº¢å‡ºé—®é¢˜äº†ã€‚

- è€Œè®©`pIndex`æœ€å°å€¼ç­‰ 1ï¼Œåˆ™éœ€è¦ `pIndex >= 1`
- å…¶ä»–ä¸€æ¬¡ä¿®æ”¹å³å¯

```
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.17;

// [11,2,31,45,6,78,37,33,21] => [2, 6, 11, 21, 31, 33, 37, 45, 78]
contract Demo {
    function insertSort(uint256[] memory ary)
        public
        pure
        returns (uint256[] memory)
    {
        uint256 temp; //å®šä¹‰ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œä¿å­˜è¦æ’å…¥çš„å€¼ï¼›
        uint256 len = ary.length;
        for (uint256 i = 1; i < len; i++) {
            if (ary[i] < ary[i - 1]) {
                temp = ary[i]; //éœ€è¦æ’å…¥çš„å€¼ï¼›
                // åŸä»£ç 
                // uint256 pIndex = i - 1; //éœ€è¦æ’å…¥å€¼çš„å‰ä¸€ä¸ªç´¢å¼•ï¼›
                // while (temp < ary[pIndex] && pIndex >= 0) {

                // æ–°ä»£ç 
                uint256 pIndex = i;
                while (temp < ary[pIndex - 1] && pIndex >= 1) {
                    // åŸä»£ç 
                    // ary[pIndex + 1] = ary[pIndex]; //ç›¸å½“äºary[i]=ary[i-1];
                    // ary[pIndex] = temp; //ç›¸å½“äºary[i-1]=temp;å®Œæˆä¸€æ³¢äº¤æ¢ï¼›

                    // æ–°ä»£ç 
                    ary[pIndex] = ary[pIndex - 1]; //ç›¸å½“äºary[i]=ary[i-1];
                    ary[pIndex - 1] = temp; //ç›¸å½“äºary[i-1]=temp;å®Œæˆä¸€æ³¢äº¤æ¢ï¼›
                    pIndex--; //å‡†å¤‡ä¸‹ä¸€æ³¢äº¤æ¢ï¼›
                }
            }
        }
        return ary;
    }
}
```

ä½†æ˜¯è¿™ä¸ªç‰ˆæœ¬çš„ä»£ç è¿˜æ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä»£ç ä¸­çš„ `temp < ary[pIndex - 1] && pIndex >= 1` è¿™é‡Œçš„ `temp < ary[pIndex - 1]` åœ¨ `pIndex--;`å `pIndex` ä¸º 0ï¼Œè€Œæ­¤æ—¶ `ary[pIndex - 1]` åˆå‡ºç°é”™è¯¯äº†ã€‚

### å†æ¬¡ä¿®å¤å¦‚ä¸‹

è¿™æ—¶å€™æˆ‘ä»¬éœ€è¦ä½¿ç”¨çŸ­è·¯è§„åˆ™ï¼ŒæŠŠæ¡ä»¶ä½ç½®æ¢ä¸€ä¸‹ï¼Œå› ä¸ºæˆ‘ä»¬è¦æ±‚ `pIndex >= 1`,å½“ `pIndex` ä¸º 0 æ—¶å€™å°±ä¸éœ€è¦ç»§ç»­è¿è¡Œäº†ã€‚

```
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.17;

// [11,2,31,45,6,78,37,33,21] => [2, 6, 11, 21, 31, 33, 37, 45, 78]
contract Demo {
    // 47897 gas
    function insertSort(uint256[] memory ary)
        public
        pure
        returns (uint256[] memory)
    {
        uint256 temp; //å®šä¹‰ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œä¿å­˜è¦æ’å…¥çš„å€¼ï¼›
        uint256 len = ary.length;
        for (uint256 i = 1; i < len; i++) {
            if (ary[i] < ary[i - 1]) {
                temp = ary[i]; //éœ€è¦æ’å…¥çš„å€¼ï¼›
                uint256 pIndex = i;
                while (pIndex >= 1 && temp < ary[pIndex - 1]) {
                    ary[pIndex] = ary[pIndex - 1]; //ç›¸å½“äºary[i]=ary[i-1];
                    ary[pIndex - 1] = temp; //ç›¸å½“äºary[i-1]=temp;å®Œæˆä¸€æ³¢äº¤æ¢ï¼›
                    pIndex--; //å‡†å¤‡ä¸‹ä¸€æ³¢äº¤æ¢ï¼›
                }
            }
        }
        return ary;
    }
}
```

è¿™ä¸‹ç»ˆäºæ‰§è¡ŒæˆåŠŸäº†ã€‚ æŸ¥çœ‹è°ƒç”¨æˆåŠŸçš„ gasï¼ŒèŠ±è´¹äº† `47897 gas`ï¼›

ç„¶åæˆ‘ä»¬å†æ¬¡å¼€å§‹æ€ä¹ˆä¼˜åŒ–è¿™äº› gasã€‚

### ä¼˜åŒ–åçš„æœ€ç»ˆç‰ˆæœ¬

ç„¶åæˆ‘ä»¬å†çœ‹çœ‹æ€ä¹ˆä¼˜åŒ–ï¼Œ

- `if (ary[i] < ary[i - 1])` ä¸ `temp < ary[pIndex - 1]` é‡å¤åˆ¤æ–­äº†
- è¾“å…¥å˜é‡çš„ä½ç½® memoryï¼Œå¯ä»¥æ”¹ä¸º `calldata`
- `i++` å¯ä»¥æ”¹ä¸º `++`;
- `pIndex--;` å¯ä»¥æ”¹ä¸º `--pIndex;`
- å†…éƒ¨å£°æ˜çš„æ‰€æœ‰å˜é‡ï¼Œéƒ½å¯ä»¥æåˆ°å¾ªç¯å¤–

æœ€ç»ˆçš„ç‰ˆæœ¬: gas æ¶ˆè€—ä»æœ€å¼€å§‹çš„ `47897 gas` ä¼˜åŒ–æˆäº† `41125 gas`

```
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.17;

// [11,2,31,45,6,78,37,33,21]
//           => [2, 6, 11, 21, 31, 33, 37, 45, 78]
// 47897 gas
// ...
// 41125 gas
contract Demo {
    // 47897 gas
    function insertSort(uint256[] calldata ary)
        public
        pure
        returns (uint256[] memory)
    {
        uint256[] memory tempArr = ary;
        uint256 temp; //å®šä¹‰ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œä¿å­˜è¦æ’å…¥çš„å€¼ï¼›
        uint256 len = tempArr.length;
        uint256 pIndex; // ä¸Šä¸€ä¸ªå€¼
        for (uint256 i = 1; i < len; ++i) {
            temp = tempArr[i]; //éœ€è¦æ’å…¥çš„å€¼ï¼›
            pIndex = i;
            while (pIndex >= 1 && temp < tempArr[pIndex - 1]) {
                tempArr[pIndex] = tempArr[pIndex - 1]; //ç›¸å½“äºary[i]=ary[i-1];
                --pIndex; //å‡†å¤‡ä¸‹ä¸€æ³¢äº¤æ¢ï¼›
            }
            tempArr[pIndex] = temp; //ç›¸å½“äºary[i-1]=temp; å› ä¸ºä¸Šé¢ pIndex-- äº†
        }
        return tempArr;
    }
}
```

## 2ï¸âƒ£ å†’æ³¡æ’åº

å†’æ³¡æ’åºï¼ˆBubble Sortï¼‰ä¹Ÿæ˜¯ä¸€ç§ç®€å•ç›´è§‚çš„æ’åºç®—æ³•ã€‚å®ƒé‡å¤åœ°èµ°è®¿è¿‡è¦æ’åºçš„æ•°åˆ—ï¼Œä¸€æ¬¡æ¯”è¾ƒä¸¤ä¸ªå…ƒç´ ï¼Œå¦‚æœä»–ä»¬çš„é¡ºåºé”™è¯¯å°±æŠŠä»–ä»¬äº¤æ¢è¿‡æ¥ã€‚èµ°è®¿æ•°åˆ—çš„å·¥ä½œæ˜¯é‡å¤åœ°è¿›è¡Œç›´åˆ°æ²¡æœ‰å†éœ€è¦äº¤æ¢ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥æ•°åˆ—å·²ç»æ’åºå®Œæˆã€‚è¿™ä¸ªç®—æ³•çš„åå­—ç”±æ¥æ˜¯å› ä¸ºè¶Šå°çš„å…ƒç´ ä¼šç»ç”±äº¤æ¢æ…¢æ…¢â€œæµ®â€åˆ°æ•°åˆ—çš„é¡¶ç«¯ã€‚
ç®—æ³•æ­¥éª¤ï¼š

- 1ï¼‰æ¯”è¾ƒç›¸é‚»çš„å…ƒç´ ã€‚å¦‚æœç¬¬ä¸€ä¸ªæ¯”ç¬¬äºŒä¸ªå¤§ï¼Œå°±äº¤æ¢ä»–ä»¬ä¸¤ä¸ªã€‚
- 2ï¼‰å¯¹æ¯ä¸€å¯¹ç›¸é‚»å…ƒç´ ä½œåŒæ ·çš„å·¥ä½œï¼Œä»å¼€å§‹ç¬¬ä¸€å¯¹åˆ°ç»“å°¾çš„æœ€åä¸€å¯¹ã€‚è¿™æ­¥åšå®Œåï¼Œæœ€åçš„å…ƒç´ ä¼šæ˜¯æœ€å¤§çš„æ•°ã€‚
- 3ï¼‰é’ˆå¯¹æ‰€æœ‰çš„å…ƒç´ é‡å¤ä»¥ä¸Šçš„æ­¥éª¤ï¼Œé™¤äº†æœ€åä¸€ä¸ªã€‚
- 4ï¼‰æŒç»­æ¯æ¬¡å¯¹è¶Šæ¥è¶Šå°‘çš„å…ƒç´ é‡å¤ä¸Šé¢çš„æ­¥éª¤ï¼Œç›´åˆ°æ²¡æœ‰ä»»ä½•ä¸€å¯¹æ•°å­—éœ€è¦æ¯”è¾ƒã€‚

```
contract Demo2 {
    function sortAry(uint256[] calldata ary)
        public
        pure
        returns (uint256[] memory)
    {
        uint256[] memory tempArr = ary;
        uint256 len = tempArr.length; //è·å–æ•°ç»„çš„é•¿åº¦ï¼›æœ‰aryLenä¸ªæ•°åœ¨æ’åºï¼›
        uint256 temp; //ä¸´æ—¶å˜é‡ï¼Œäº¤æ¢æ•°æ®ä¸­ç”¨çš„
        bool flag = false; //è®¾ç½®æ ‡å¿—ä½ï¼Œåˆå§‹åŒ–ä¸ºfalse
        for (uint256 i = 0; i < len - 1; ++i) {
            //å¤–å±‚å¾ªç¯n-1æ¬¡ï¼›
            for (uint256 j = 0; j < len - 1 - i; ++j) {
                //æ¯æ¬¡å¾ªç¯å®Œï¼Œéƒ½èƒ½ä»å‰©ä¸‹çš„æ•°ç»„ä¸­æ‰¾å‡ºä¸ªæœ€å¤§çš„æ•°ç»„æ”¾åœ¨ len-1-i çš„ä½ç½®ï¼›
                if (tempArr[j] > tempArr[j + 1]) {
                    temp = tempArr[j];
                    tempArr[j] = tempArr[j + 1];
                    tempArr[j + 1] = temp;
                    flag = true; //å¦‚æœäº¤æ¢å¥½äº†ï¼Œåšä¸ªæ ‡è®°ï¼Œé¿å…æ— æ•ˆçš„å¾ªç¯ï¼›
                }
            }
            if (!!flag) {
                //åªè¦äº¤æ¢äº†ä½ç½®ï¼Œflagçš„å€¼å°±é‡æ–°è®¾ç½®ä¸ºfalseäº†ï¼›
                flag = false;
            } else {
                //å¦‚æœæ²¡æœ‰äº¤æ¢ï¼Œè¯´æ˜æ•°ç»„å·²ç»æ’å¥½åºäº†ï¼Œå¯ä»¥ç»“æŸå¾ªç¯äº†ï¼›
                break;
            }
        }
        return tempArr;
    }
}
```

## ğŸ†— å®æˆ˜åº”ç”¨

å¿«é€Ÿæ’åºå’Œæ•°ç»„å»é‡ä½œä¸ºæ‰©å±•ç»ƒä¹ ï¼Œè‡ªå·±å¯ä»¥åŠ¨æ‰‹å®ç°ã€‚

- å®ç°å¿«é€Ÿæ’åº
- å®ç°æ•°ç»„å»é‡

## #ï¸âƒ£ é—®ç­”é¢˜

- æ’å…¥æ’åºçš„å†™æ³•
  ```
    function insertSort(uint256[] calldata ary)
    public
    pure
    returns (uint256[] memory)
    {
        uint256[] memory tempArr = ary;
        uint256 temp; //å®šä¹‰ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œä¿å­˜è¦æ’å…¥çš„å€¼ï¼›
        uint256 len = tempArr.length;
        uint256 pIndex; // ä¸Šä¸€ä¸ªå€¼
        for (uint256 i = 1; i < len; ++i) {
            temp = tempArr[i]; //éœ€è¦æ’å…¥çš„å€¼ï¼›
            pIndex = i;
            while (pIndex >= 1 && temp < tempArr[pIndex - 1]) {
                tempArr[pIndex] = tempArr[pIndex - 1]; //ç›¸å½“äºary[i]=ary[i-1];
                --pIndex; //å‡†å¤‡ä¸‹ä¸€æ³¢äº¤æ¢ï¼›
            }
            tempArr[pIndex] = temp; //ç›¸å½“äºary[i-1]=temp; å› ä¸ºä¸Šé¢ pIndex-- äº†
        }
        return tempArr;
    }
  ```
  - `if (ary[i] < ary[i - 1])` ä¸ `temp < ary[pIndex - 1]` é‡å¤åˆ¤æ–­äº†
  - è¾“å…¥å˜é‡çš„ä½ç½® memoryï¼Œå¯ä»¥æ”¹ä¸º `calldata`
  - `i++` å¯ä»¥æ”¹ä¸º `++`;
  - `pIndex--;` å¯ä»¥æ”¹ä¸º `--pIndex;`
  - å†…éƒ¨å£°æ˜çš„æ‰€æœ‰å˜é‡ï¼Œéƒ½å¯ä»¥æåˆ°å¾ªç¯å¤–
