# 14.Library:åº“

åº“ library æ˜¯æ™ºèƒ½åˆçº¦çš„ç²¾ç®€ç‰ˆï¼Œå°±åƒæ™ºèƒ½åˆçº¦ä¸€æ ·ï¼Œä½äºåŒºå—é“¾ä¸Šï¼ŒåŒ…å«å¯ä»¥è¢«å…¶ä»–åˆçº¦ä½¿ç”¨çš„ä»£ç ã€‚åº“åˆçº¦æœ‰ä¸¤ç§ä½¿ç”¨æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨å’Œ `using...for...` ä½¿ç”¨ã€‚

## 1ï¸âƒ£ åº“åˆçº¦ä¸æ™®é€šæ™ºèƒ½åˆçº¦åŒºåˆ«

åº“ä¸åˆçº¦ç±»ä¼¼ï¼Œåº“çš„ç›®çš„æ˜¯åªéœ€è¦åœ¨ç‰¹å®šçš„åœ°å€éƒ¨ç½²ä¸€æ¬¡ï¼Œè€Œå®ƒä»¬çš„ä»£ç å¯ä»¥é€šè¿‡
EVM çš„ `DELEGATECALL` ç‰¹æ€§è¿›è¡Œé‡ç”¨ã€‚è¿™æ„å‘³ç€å¦‚æœåº“å‡½æ•°è¢«è°ƒç”¨ï¼Œå®ƒçš„ä»£ç åœ¨è°ƒç”¨åˆçº¦çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œå³ `this` æŒ‡å‘è°ƒç”¨åˆçº¦ï¼Œç‰¹åˆ«æ³¨æ„ï¼Œä»–è®¿é—®çš„æ˜¯è°ƒç”¨åˆçº¦å­˜å‚¨çš„çŠ¶æ€ã€‚å› ä¸ºæ¯ä¸ªåº“éƒ½æ˜¯ä¸€æ®µç‹¬ç«‹çš„ä»£ç ï¼Œæ‰€ä»¥å®ƒä»…èƒ½è®¿é—®è°ƒç”¨åˆçº¦æ˜ç¡®æä¾›çš„çŠ¶æ€å˜é‡ï¼ˆå¦åˆ™å®ƒå°±æ— æ³•é€šè¿‡åå­—è®¿é—®è¿™äº›å˜é‡ï¼‰ã€‚

- **åº“ä¸èƒ½æœ‰ä»»ä½•çŠ¶æ€å˜é‡**
- **å®ƒä»¬ä¹Ÿä¸èƒ½ç»§æ‰¿å…¶ä»–åˆçº¦**ã€‚
- åº“åˆçº¦å‡½æ•°çš„å¯è§†èŒƒå›´é€šå¸¸ä¸º `internal`ï¼Œå¯å˜æ€§ä¸º `pure`ï¼Œä¹Ÿå°±æ˜¯å¯¹æ‰€æœ‰ä½¿ç”¨å®ƒçš„åˆçº¦å¯è§ã€‚
  - å®šä¹‰æˆ `external` æ¯«æ— æ„ä¹‰ï¼Œå› ä¸ºåº“åˆçº¦å‡½æ•°åªåœ¨å†…éƒ¨ä½¿ç”¨ï¼Œä¸ç‹¬ç«‹è¿è¡Œã€‚
  - åŒæ ·å®šä¹‰æˆ `private` ä¹Ÿä¸è¡Œï¼Œå› ä¸ºå…¶å®ƒåˆçº¦æ— æ³•ä½¿ç”¨ã€‚
- ç¦æ­¢ä½¿ç”¨ `fallback` / `receive` å‡½æ•°ï¼Œæ‰€ä»¥å¯¼è‡´ä¹Ÿä¸èƒ½æ¥æ”¶ä»¥å¤ªå¸
- Library è¢«é”€æ¯åï¼Œåˆ™æ‰€æœ‰æ–¹æ³•æ¢å¤ä¸ºåˆå§‹å€¼ï¼ŒåŠŸèƒ½å¤±æ•ˆã€‚
- ä½¿ç”¨åº“ library çš„åˆçº¦ï¼Œå¯ä»¥å°†åº“åˆçº¦è§†ä¸ºéšå¼çš„çˆ¶åˆçº¦ï¼Œå½“ç„¶å®ƒä»¬ä¸ä¼šæ˜¾å¼çš„å‡ºç°åœ¨ç»§æ‰¿å…³ç³»ä¸­ã€‚ä¹Ÿå°±æ˜¯ä¸ç”¨å†™ `is` æ¥ç»§æ‰¿ï¼Œç›´æ¥å¯ä»¥åœ¨åˆçº¦ä¸­ä½¿ç”¨ã€‚
- åº“åˆçº¦çš„åå­—ä¹Ÿéœ€è¦é¦–å­—æ¯å¤§å†™

å¯ä»¥é€šè¿‡ç±»å‹è½¬æ¢, å°†åº“ç±»å‹æ›´æ”¹ä¸º `address` ç±»å‹, ä¾‹å¦‚: ä½¿ç”¨`address(LibraryName)`,ç”±äºç¼–è¯‘å™¨æ— æ³•çŸ¥é“åº“çš„éƒ¨ç½²ä½ç½®ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆ`__$30bbc0abd4d6364515865950d3e0d10953$__`å½¢å¼çš„å ä½ç¬¦ï¼Œè¯¥å ä½ç¬¦æ˜¯å®Œæ•´çš„åº“åç§°çš„ keccak256 å“ˆå¸Œçš„åå…­è¿›åˆ¶ç¼–ç çš„ 34 ä¸ªå­—ç¬¦çš„å‰ç¼€ï¼Œä¾‹å¦‚ï¼šå¦‚æœè¯¥åº“å­˜å‚¨åœ¨ libraries ç›®å½•ä¸­åä¸º bigint.sol çš„æ–‡ä»¶ä¸­ï¼Œåˆ™å®Œæ•´çš„åº“åç§°ä¸º`libraries/bigint.sol:BigInt`ã€‚

æ­¤ç±»å­—èŠ‚ç ä¸å®Œæ•´çš„åˆçº¦ï¼Œä¸åº”è¯¥éƒ¨ç½²ã€‚å ä½ç¬¦éœ€è¦æ›¿æ¢ä¸ºå®é™…åœ°å€ã€‚ä½ å¯ä»¥é€šè¿‡åœ¨ç¼–è¯‘åº“æ—¶å°†å®ƒä»¬ä¼ é€’ç»™ç¼–è¯‘å™¨æˆ–ä½¿ç”¨é“¾æ¥å™¨æ›´æ–°å·²ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶æ¥å®ç°ã€‚æœ‰å…³å¦‚ä½•ä½¿ç”¨å‘½ä»¤è¡Œç¼–è¯‘å™¨è¿›è¡Œé“¾æ¥çš„ä¿¡æ¯ï¼Œè¯·å‚è§ [`library-linking`](https://learnblockchain.cn/docs/solidity/using-the-compiler.html#/library-linking) ã€‚

## 2ï¸âƒ£ ç›´æ¥è°ƒç”¨åº“åˆçº¦æ–¹æ³•

### æ¡ˆä¾‹ 1

```
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.17;

library Math {
    function max(uint256 _x, uint256 _y) internal pure returns (uint256) {
        return _x > _y ? _x : _y;
    }
}

contract Test {
    function testMax(uint256 _x, uint256 _y) external pure returns (uint256) {
        return Math.max(_x, _y);
    }
}
```

### æ¡ˆä¾‹ 2

```
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.17;

library ArrayLib {
    function find(uint256[] storage _arr, uint256 _value)
        internal
        view
        returns (uint256)
    {
        for (uint256 index = 0; index < _arr.length; index++) {
            if (_arr[index] == _value) {
                return index;
            }
        }
        revert("Not Found");
    }
}

contract Test {
    uint256[] public arr = [10, 11, 12, 13, 14, 15, 16, 17, 18, 19];

    // ä¼šæˆåŠŸ
    function test1() external view returns (uint256) {
        return ArrayLib.find(arr, 15);
    }

    // ä¼šå¤±è´¥
    function test2() external view returns (uint256) {
        return ArrayLib.find(arr, 99);
    }
}
```

## 3ï¸âƒ£ `using...for...` ä½¿ç”¨åº“åˆçº¦

ä½¿ç”¨åº“åˆçº¦è¿˜æœ‰æ›´æ–¹ä¾¿çš„æ–¹æ³•ï¼Œé‚£å°±æ˜¯ `using for` æŒ‡ä»¤ã€‚

ä¾‹å¦‚ï¼š`using A for B` ç”¨æ¥å°† A åº“é‡Œå®šä¹‰çš„å‡½æ•°é™„ç€åˆ°ç±»å‹ Bã€‚**è¿™äº›å‡½æ•°å°†ä¼šé»˜è®¤æ¥æ”¶è°ƒç”¨å‡½æ•°å¯¹è±¡çš„å®ä¾‹ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°**ã€‚
using For å¯åœ¨æ–‡ä»¶æˆ–åˆçº¦å†…éƒ¨åŠåˆçº¦çº§éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚

æ ¸å¿ƒå¦‚ä¸‹:

```
using ArrayLib for uint256[];
uint256[] public arr = [10, 11, 12, 13, 14,...];
...
arr.find(15); // ç›´æ¥ä½¿ç”¨
...
```

### ä¾‹å­ 1

```
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.17;

library ArrayLib {
    function find(uint256[] storage _arr, uint256 _value)
        internal
        view
        returns (uint256)
    {
        for (uint256 index = 0; index < _arr.length; index++) {
            if (_arr[index] == _value) {
                return index;
            }
        }
        revert("Not Found");
    }
}

contract Test {
    // using for å¯ä»¥è®©æ‰€æœ‰ uint256[] æ•°æ®ï¼Œéƒ½å…·æœ‰ ArrayLib å†…çš„æ–¹æ³•
    using ArrayLib for uint256[];

    uint256[] public arr = [10, 11, 12, 13, 14, 15, 16, 17, 18, 19];

    function test1() external view returns (uint256) {
        // return ArrayLib.find(arr, 15);

        // å¯ä»¥ç›´æ¥ä½¿ç”¨ arr.findï¼Œè€Œä¸éœ€è¦é¢å¤–ä¿®æ”¹ ArrayLib å†…çš„ä»£ç 
        return arr.find(15);
    }

    function test2() external view returns (uint256) {
        // return ArrayLib.find(arr, 99);
        return arr.find(99);
    }
}

```

### using for å…¶ä»–ç”¨æ³•


ç¬¬ä¸€éƒ¨åˆ† `A` å¯ä»¥æ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼š

- ä¸€äº›åº“æˆ–æ–‡ä»¶çº§çš„å‡½æ•°åˆ—è¡¨(`using {f, g, h, L.t} for uint;`)ï¼Œä»…æ˜¯é‚£äº›å‡½æ•°è¢«é™„åŠ åˆ°ç±»å‹ã€‚
- åº“åç§° (`using L for uint;`) ï¼Œåº“é‡Œæ‰€æœ‰çš„å‡½æ•°(åŒ…æ‹¬ public å’Œ  internal å‡½æ•°) è¢«é™„åŠ åˆ°ç±»å‹ä¸Šã€‚

åœ¨æ–‡ä»¶çº§ï¼Œç¬¬äºŒéƒ¨åˆ† `B` å¿…é¡»æ˜¯ä¸€ä¸ªæ˜¾å¼ç±»å‹ï¼ˆä¸ç”¨æŒ‡å®šæ•°æ®ä½ç½®ï¼‰

åœ¨åˆçº¦å†…ï¼Œä½ å¯ä»¥ä½¿ç”¨ `using L for *;`ï¼Œ è¡¨ç¤ºåº“ `L`ä¸­çš„å‡½æ•°è¢«é™„åŠ åœ¨æ‰€æœ‰ç±»å‹ä¸Šã€‚

å¦‚æœä½ æŒ‡å®šä¸€ä¸ªåº“ï¼Œåº“å†…æ‰€æœ‰å‡½æ•°éƒ½ä¼šè¢«åŠ è½½ï¼Œå³ä½¿å®ƒä»¬çš„ç¬¬ä¸€ä¸ªå‚æ•°ç±»å‹ä¸å¯¹è±¡çš„ç±»å‹ä¸åŒ¹é…ã€‚ç±»å‹æ£€æŸ¥ä¼šåœ¨å‡½æ•°è°ƒç”¨å’Œé‡è½½è§£ææ—¶æ‰§è¡Œã€‚

å¦‚æœä½ ä½¿ç”¨å‡½æ•°åˆ—è¡¨ (`using {f, g, h, L.t} for uint;`)ï¼Œ é‚£ä¹ˆç±»å‹
(`uint`) ä¼šéšå¼çš„è½¬æ¢ä¸ºè¿™äº›å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚
å³ä¾¿è¿™äº›å‡½æ•°ä¸­æ²¡æœ‰ä¸€ä¸ªè¢«è°ƒç”¨ï¼Œè¿™ä¸ªæ£€æŸ¥ä¹Ÿä¼šè¿›è¡Œã€‚

`using A for B;` æŒ‡ä»¤ä»…åœ¨å½“å‰ä½œç”¨åŸŸæœ‰æ•ˆï¼ˆè¦ä¹ˆæ˜¯åˆçº¦ä¸­ï¼Œæˆ–å½“å‰æ¨¡å—ã€æˆ–æºç å•å…ƒï¼‰ï¼ŒåŒ…æ‹¬åœ¨ä½œç”¨åŸŸå†…çš„æ‰€æœ‰å‡½æ•°ï¼Œåœ¨åˆçº¦æˆ–æ¨¡å—ä¹‹å¤–åˆ™æ— æ•ˆã€‚

å½“ `using for` æŒ‡ä»¤åœ¨æ–‡ä»¶çº§åˆ«ä½¿ç”¨ï¼Œå¹¶åº”ç”¨äºä¸€ä¸ªç”¨æˆ·å®šä¹‰ç±»å‹ï¼ˆåœ¨ç”¨ä¸€ä¸ªæ–‡ä»¶å®šä¹‰çš„æ–‡ä»¶çº§åˆ«çš„ç”¨æˆ·ç±»å‹ï¼‰ï¼Œ`global` å…³é”®å­—å¯ä»¥æ·»åŠ åˆ°æœ«å°¾ã€‚äº§ç”Ÿçš„æ•ˆæœæ˜¯ï¼Œè¿™äº›å‡½æ•°è¢«é™„åŠ åˆ°ä½¿ç”¨è¯¥ç±»å‹çš„ä»»ä½•åœ°æ–¹ï¼ˆåŒ…æ‹¬å…¶ä»–æ–‡ä»¶ï¼‰ï¼Œè€Œä¸ä»…ä»…æ˜¯å£°æ˜å¤„æ‰€åœ¨çš„ä½œç”¨åŸŸã€‚

è®©æˆ‘ä»¬é‡å†™ä¸€ä¸‹æ¥è‡ª libraries ä¸€èŠ‚ä¸­çš„ä¾‹å­ï¼Œä½¿ç”¨æ–‡ä»¶çº§å‡½æ•°è€Œä¸æ˜¯åº“å‡½æ•°çš„æ–¹å¼é‡å†™ã€‚

```
    struct Data { mapping(uint => bool) flags; }
    // Now we attach functions to the type.
    // The attached functions can be used throughout the rest of the module.
    // If you import the module, you have to
    // repeat the using directive there, for example as
    //   import "flags.sol" as Flags;
    //   using {Flags.insert, Flags.remove, Flags.contains}
    //     for Flags.Data;
    using {insert, remove, contains} for Data;

    function insert(Data storage self, uint value)
        returns (bool)
    {
        if (self.flags[value])
            return false; // already there
        self.flags[value] = true;
        return true;
    }

    function remove(Data storage self, uint value)
        returns (bool)
    {
        if (!self.flags[value])
            return false; // not there
        self.flags[value] = false;
        return true;
    }

    function contains(Data storage self, uint value)
        public
        view
        returns (bool)
    {
        return self.flags[value];
    }


    contract C {
        Data knownValues;

        function register(uint value) public {
            // Here, all variables of type Data have
            // corresponding member functions.
            // The following function call is identical to
            // `Set.insert(knownValues, value)`
            require(knownValues.insert(value));
        }
    }
```

ä¹Ÿå¯ä»¥åƒè¿™æ ·æ‰©å±•å†…ç½®åŸºæœ¬ç±»å‹ï¼Œåœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åº“ï¼š

```
    // SPDX-License-Identifier: GPL-3.0
    pragma solidity ^0.8.13;

    library Search {
        function indexOf(uint[] storage self, uint value)
            public
            view
            returns (uint)
        {
            for (uint i = 0; i < self.length; i++)
                if (self[i] == value) return i;
            return type(uint).max;
        }
    }

    using Search for uint[];

    contract C {
        using Search for uint[];
        uint[] data;

        function append(uint value) public {
            data.push(value);
        }

        function replace(uint from, uint to) public {
            // æ‰§è¡Œåº“å‡½æ•°è°ƒç”¨
            uint index = data.indexOf(from);
            if (index == type(uint).max)
                data.push(to);
            else
                data[index] = to;
        }
    }
```

æ³¨æ„ï¼Œæ‰€æœ‰ external åº“è°ƒç”¨éƒ½æ˜¯å®é™…çš„ EVM å‡½æ•°è°ƒç”¨ã€‚è¿™æ„å‘³ç€å¦‚æœä¼ é€’å†…å­˜æˆ–å€¼ç±»å‹ï¼Œéƒ½å°†äº§ç”Ÿä¸€ä¸ªå‰¯æœ¬ï¼Œå³ä½¿æ˜¯ `self` å˜é‡ã€‚ å¼•ç”¨å­˜å‚¨å˜é‡æˆ–è€… internal åº“è°ƒç”¨ æ˜¯å”¯ä¸€ä¸ä¼šå‘ç”Ÿæ‹·è´çš„æƒ…å†µã€‚


## 4ï¸âƒ£ ç›´æ¥è°ƒç”¨ å’Œ using for å¯¹æ¯”

- using for æ›´ç¬¦åˆè¯­ä¹‰åŒ–
- åº“åˆçº¦ä½¿ç”¨ using for æ¯”ç›´æ¥ä½¿ç”¨æ›´çœ gas

```
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.17;

library Sum {
    function sum(uint256[] memory _data) public pure returns (uint256 temp) {
        for (uint256 i = 0; i < _data.length; ++i) {
            temp += _data[i];
        }
    }
}

contract Test {
    using Sum for uint256[];
    uint256[] data;

    constructor() {
        data.push(1);
        data.push(2);
        data.push(3);
        data.push(4);
        data.push(5);
    }

    // 43874 gas
    function sumA1() external view returns (uint256) {
        return Sum.sum(data);
    }

    // 43531 gas
    function sumA2() external view returns (uint256) {
        return data.sum();
    }
}
```

## 5ï¸âƒ£ é”€æ¯åˆçº¦åº“

```
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.17;

library Math {
    function max(uint256 _x, uint256 _y) internal pure returns (uint256) {
        return _x > _y ? _x : _y;
    }

    function kill() internal {
        selfdestruct(payable(msg.sender));
    }

    // Libraries cannot have fallback functions.
    // fallback() external {}

    // Libraries cannot have receive ether functions.
    // receive() external payable {}
}

contract Test {
    function testMax(uint256 _x, uint256 _y) external pure returns (uint256) {
        return Math.max(_x, _y);
    }

    function testKill() external {
        return Math.kill();
    }
}
```

- æ‰§è¡Œ `Test.testMax`
- æ‰§è¡Œ `Test.testKill`
- å†æ¬¡æ‰§è¡Œ `Test.testMax`ï¼Œå‘ç°ç»“æœæ˜¯é»˜è®¤å€¼

## 6ï¸âƒ£ æ‰©å±•é˜…è¯»

### åº“çš„å‡½æ•°ç­¾åä¸é€‰æ‹©å™¨

é™¤äº†æŒ‡å‘å­˜å‚¨çš„æŒ‡é’ˆä»¥å¤–ï¼Œå‚æ•°ç¼–ç ä¸å¸¸è§„åˆçº¦ ABI ç›¸åŒï¼Œå­˜å‚¨æŒ‡é’ˆè¢«ç¼–ç ä¸º
`uint256` å€¼ï¼ŒæŒ‡å‘å®ƒä»¬æ‰€æŒ‡å‘çš„å­˜å‚¨æ’æ§½ã€‚

ä¸åˆçº¦ ABI ç›¸ä¼¼ï¼Œé€‰æ‹©å™¨ç”±ç­¾åçš„ Keccak256 å“ˆå¸Œçš„å‰å››ä¸ªå­—èŠ‚ç»„æˆã€‚å¯ä»¥ä½¿ç”¨
.selector æˆå‘˜ä» Solidity ä¸­è·å–å…¶å€¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
    pragma solidity >=0.5.14 <0.9.0;

    library L {
        function f(uint256) external {}
    }

    contract C {
        function g() public pure returns (bytes4) {
            return L.f.selector;
        }
    }
```

å°½ç®¡å¯ä»¥å¯¹ public æˆ– external çš„åº“å‡½æ•°è¿›è¡Œå¤–éƒ¨è°ƒç”¨ï¼Œä½†æ­¤ç±»è°ƒç”¨ä¼šè¢«è§†ä¸º Solidity çš„å†…éƒ¨è°ƒç”¨ï¼Œä¸å¸¸è§„çš„ contract ABI è§„åˆ™ä¸åŒã€‚å¤–éƒ¨åº“å‡½æ•°æ¯”å¤–éƒ¨åˆçº¦å‡½æ•°æ”¯æŒæ›´å¤šçš„å‚æ•°ç±»å‹ï¼Œä¾‹å¦‚é€’å½’ç»“æ„å’ŒæŒ‡å‘å­˜å‚¨çš„æŒ‡é’ˆã€‚

å› æ­¤ï¼Œè®¡ç®—ç”¨äºè®¡ç®— 4 å­—èŠ‚é€‰æ‹©å™¨çš„å‡½æ•°ç­¾åéµå¾ªå†…éƒ¨å‘½åæ¨¡å¼ä»¥åŠå¯å¯¹åˆçº¦ ABI ä¸­ä¸æ”¯æŒçš„ç±»å‹çš„å‚æ•°ä½¿ç”¨å†…éƒ¨ç¼–ç ã€‚

ä»¥ä¸‹æ ‡è¯†ç¬¦å¯ä»¥ä½œä¸ºå‡½æ•°ç­¾åä¸­çš„ç±»å‹ï¼š

- å€¼ç±»å‹, éå­˜å‚¨çš„ï¼ˆnon-storageï¼‰ `string` åŠéå­˜å‚¨çš„ `bytes`
  ä½¿ç”¨å’Œåˆçº¦ ABI ä¸­åŒæ ·çš„æ ‡è¯†ç¬¦ã€‚
- éå­˜å‚¨çš„æ•°ç»„ç±»å‹éµå¾ªåˆçº¦ ABI ä¸­åŒæ ·çš„è§„åˆ™ï¼Œä¾‹å¦‚ `<type>[]`
  ä¸ºåŠ¨æ€æ•°ç»„ä»¥åŠ `<type>[M]` ä¸º `M` ä¸ªå…ƒç´ çš„åŠ¨æ€æ•°ç»„ã€‚
- éå­˜å‚¨çš„ç»“æ„ä½“ä½¿ç”¨å®Œæ•´çš„å‘½åå¼•ç”¨ï¼Œä¾‹å¦‚ `C.S` ç”¨äº
  `contract C { struct S { ... } }`.
- å­˜å‚¨çš„æ˜ å°„æŒ‡é’ˆä½¿ç”¨ `mapping(<keyType> => <valueType>) storage` å½“
  `<keyType>` å’Œ `<valueType>` æ˜¯æ˜ å°„çš„é”®å’Œå€¼ç±»å‹ã€‚
- å…¶ä»–çš„å­˜å‚¨çš„æŒ‡é’ˆç±»å‹ä½¿ç”¨å…¶å¯¹åº”çš„éå­˜å‚¨ç±»å‹çš„ç±»å‹æ ‡è¯†ç¬¦ï¼Œä½†åœ¨å…¶åé¢é™„åŠ ä¸€ä¸ªç©ºæ ¼åŠ
  `storage` ã€‚


### åº“çš„è°ƒç”¨ä¿æŠ¤

å¦‚æœåº“çš„ä»£ç æ˜¯é€šè¿‡ `CALL` æ¥æ‰§è¡Œï¼Œè€Œä¸æ˜¯ `DELEGATECALL` é‚£ä¹ˆæ‰§è¡Œçš„ç»“æœä¼šè¢«å›é€€ï¼Œé™¤éæ˜¯å¯¹ `view` æˆ–è€… `pure` å‡½æ•°çš„è°ƒç”¨ã€‚EVM æ²¡æœ‰ä¸ºåˆçº¦æä¾›æ£€æµ‹æ˜¯å¦ä½¿ç”¨ `CALL` çš„ç›´æ¥æ–¹å¼ï¼Œä½†æ˜¯åˆçº¦å¯ä»¥ä½¿ç”¨`ADDRESS` æ“ä½œç æ‰¾å‡ºæ­£åœ¨è¿è¡Œçš„"ä½ç½®"ã€‚ç”Ÿæˆçš„ä»£ç é€šè¿‡æ¯”è¾ƒè¿™ä¸ªåœ°å€å’Œæ„é€ æ—¶çš„åœ°å€æ¥ç¡®å®šè°ƒç”¨æ¨¡å¼ã€‚

æ›´å…·ä½“åœ°è¯´ï¼Œåº“çš„è¿è¡Œæ—¶ä»£ç æ€»æ˜¯ä»ä¸€ä¸ª push æŒ‡ä»¤å¼€å§‹ï¼Œå®ƒåœ¨ç¼–è¯‘æ—¶æ˜¯ 20 å­—èŠ‚çš„é›¶ã€‚å½“è¿è¡Œéƒ¨ç½²ä»£ç æ—¶ï¼Œè¿™ä¸ªå¸¸æ•°è¢«å†…å­˜ä¸­çš„å½“å‰åœ°å€æ›¿æ¢ï¼Œä¿®æ”¹åçš„ä»£ç å­˜å‚¨åœ¨åˆçº¦ä¸­ã€‚åœ¨è¿è¡Œæ—¶ï¼Œéƒ¨ç½²æ—¶åœ°å€å°±æˆä¸ºäº†ç¬¬ä¸€ä¸ªè¢« push åˆ°å †æ ˆä¸Šçš„å¸¸æ•°ï¼Œ å¯¹äºä»»ä½• non-view å’Œ non-pure å‡½æ•°ï¼Œè°ƒåº¦å™¨ä»£ç éƒ½å°†å¯¹æ¯”å½“å‰åœ°å€ä¸è¿™ä¸ªå¸¸æ•°æ˜¯å¦ä¸€è‡´ã€‚è¿™æ„å‘³ç€åº“åœ¨é“¾ä¸Šå­˜å‚¨çš„å®é™…ä»£ç ä¸ç¼–è¯‘å™¨è¾“å‡ºçš„ `deployedBytecode` çš„ç¼–ç æ˜¯ä¸åŒã€‚

## ğŸ†— å®æˆ˜åº”ç”¨

## #ï¸âƒ£ é—®ç­”é¢˜

- åº“åˆçº¦ä¸æ™®é€šæ™ºèƒ½åˆçº¦åŒºåˆ«
  - **åº“ä¸èƒ½æœ‰ä»»ä½•çŠ¶æ€å˜é‡**
  - **å®ƒä»¬ä¹Ÿä¸èƒ½ç»§æ‰¿å…¶ä»–åˆçº¦**ã€‚
  - åº“åˆçº¦å‡½æ•°çš„å¯è§†èŒƒå›´é€šå¸¸ä¸º `internal`ï¼Œå¯å˜æ€§ä¸º `pure`ï¼Œä¹Ÿå°±æ˜¯å¯¹æ‰€æœ‰ä½¿ç”¨å®ƒçš„åˆçº¦å¯è§ã€‚
    - å®šä¹‰æˆ `external` æ¯«æ— æ„ä¹‰ï¼Œå› ä¸ºåº“åˆçº¦å‡½æ•°åªåœ¨å†…éƒ¨ä½¿ç”¨ï¼Œä¸ç‹¬ç«‹è¿è¡Œã€‚
    - åŒæ ·å®šä¹‰æˆ `private` ä¹Ÿä¸è¡Œï¼Œå› ä¸ºå…¶å®ƒåˆçº¦æ— æ³•ä½¿ç”¨ã€‚
  - ç¦æ­¢ä½¿ç”¨ `fallback` / `receive` å‡½æ•°ï¼Œæ‰€ä»¥å¯¼è‡´ä¹Ÿä¸èƒ½æ¥æ”¶ä»¥å¤ªå¸
  - Library è¢«é”€æ¯åï¼Œåˆ™æ‰€æœ‰æ–¹æ³•æ¢å¤ä¸ºåˆå§‹å€¼ï¼ŒåŠŸèƒ½å¤±æ•ˆã€‚
  - ä½¿ç”¨åº“ library çš„åˆçº¦ï¼Œå¯ä»¥å°†åº“åˆçº¦è§†ä¸ºéšå¼çš„çˆ¶åˆçº¦ï¼Œå½“ç„¶å®ƒä»¬ä¸ä¼šæ˜¾å¼çš„å‡ºç°åœ¨ç»§æ‰¿å…³ç³»ä¸­ã€‚ä¹Ÿå°±æ˜¯ä¸ç”¨å†™ `is` æ¥ç»§æ‰¿ï¼Œç›´æ¥å¯ä»¥åœ¨åˆçº¦ä¸­ä½¿ç”¨ã€‚
  - åº“åˆçº¦çš„åå­—ä¹Ÿéœ€è¦é¦–å­—æ¯å¤§å†™
  - åº“ä¸åˆçº¦ç±»ä¼¼ï¼Œåº“çš„ç›®çš„æ˜¯åªéœ€è¦åœ¨ç‰¹å®šçš„åœ°å€éƒ¨ç½²ä¸€æ¬¡ï¼Œè€Œå®ƒä»¬çš„ä»£ç å¯ä»¥é€šè¿‡
EVM çš„ `DELEGATECALL` ç‰¹æ€§è¿›è¡Œé‡ç”¨ã€‚è¿™æ„å‘³ç€å¦‚æœåº“å‡½æ•°è¢«è°ƒç”¨ï¼Œå®ƒçš„ä»£ç åœ¨è°ƒç”¨åˆçº¦çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œå³ `this` æŒ‡å‘è°ƒç”¨åˆçº¦ï¼Œç‰¹åˆ«æ³¨æ„ï¼Œä»–è®¿é—®çš„æ˜¯è°ƒç”¨åˆçº¦å­˜å‚¨çš„çŠ¶æ€ã€‚å› ä¸ºæ¯ä¸ªåº“éƒ½æ˜¯ä¸€æ®µç‹¬ç«‹çš„ä»£ç ï¼Œæ‰€ä»¥å®ƒä»…èƒ½è®¿é—®è°ƒç”¨åˆçº¦æ˜ç¡®æä¾›çš„çŠ¶æ€å˜é‡ï¼ˆå¦åˆ™å®ƒå°±æ— æ³•é€šè¿‡åå­—è®¿é—®è¿™äº›å˜é‡ï¼‰ã€‚
  - å¯ä»¥é€šè¿‡ç±»å‹è½¬æ¢, å°†åº“ç±»å‹æ›´æ”¹ä¸º `address` ç±»å‹, ä¾‹å¦‚: ä½¿ç”¨`address(LibraryName)`,ç”±äºç¼–è¯‘å™¨æ— æ³•çŸ¥é“åº“çš„éƒ¨ç½²ä½ç½®ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆ`__$30bbc0abd4d6364515865950d3e0d10953$__`å½¢å¼çš„å ä½ç¬¦ï¼Œè¯¥å ä½ç¬¦æ˜¯å®Œæ•´çš„åº“åç§°çš„ keccak256 å“ˆå¸Œçš„åå…­è¿›åˆ¶ç¼–ç çš„ 34 ä¸ªå­—ç¬¦çš„å‰ç¼€ï¼Œä¾‹å¦‚ï¼šå¦‚æœè¯¥åº“å­˜å‚¨åœ¨ libraries ç›®å½•ä¸­åä¸º bigint.sol çš„æ–‡ä»¶ä¸­ï¼Œåˆ™å®Œæ•´çš„åº“åç§°ä¸º`libraries/bigint.sol:BigInt`ã€‚
- åº“åˆçº¦å¦‚ä½•è°ƒç”¨ï¼Ÿ
  - æœ‰ä¸¤ç§æ–¹æ³•è°ƒç”¨
  - 1 ç›´æ¥è°ƒç”¨åº“åˆçº¦æ–¹æ³•ï¼š`ArrayLib.find(arr, 99);`
  - 2 `using...for...` ä½¿ç”¨åº“åˆçº¦
    ```
    using ArrayLib for uint256[];
    uint256[] public arr = [10, 11, 12, 13, 14,...];
    ...
    arr.find(15); // ç›´æ¥ä½¿ç”¨
    ...
    ```
- ç›´æ¥è°ƒç”¨ å’Œ using for å¯¹æ¯”
  - `using for` æ›´ç¬¦åˆè¯­ä¹‰åŒ–
  - åº“åˆçº¦ä½¿ç”¨ `using for` æ¯”ç›´æ¥ä½¿ç”¨æ›´çœ gas
