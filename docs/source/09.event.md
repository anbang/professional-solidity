# 09.äº‹ä»¶

äº‹ä»¶æ˜¯èƒ½æ–¹ä¾¿åœ°è°ƒç”¨ä»¥å¤ªåŠè™šæ‹Ÿæœºæ—¥å¿—åŠŸèƒ½çš„æ¥å£ã€‚åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡ä»¥å¤ªåŠå®¢æˆ·ç«¯çš„ RPC æ¥å£è®¢é˜…å’Œç›‘å¬è¿™äº›äº‹ä»¶ã€‚

**é‡ç‚¹:è®°å½•åŒºå—é“¾çš„æ—¥å¿—ï¼Œå¯ä»¥ä½¿ç”¨çŠ¶æ€å˜é‡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨äº‹ä»¶ Eventï¼Œä½† Event ä½¿ç”¨çš„ gas è´¹æ¯”çŠ¶æ€å˜é‡ä½ã€‚**

åŸåˆ™ï¼šæ”¹å˜çŠ¶æ€å˜é‡æ—¶ï¼Œä¸€å®šè¦è§¦å‘äº‹ä»¶ã€‚

Soliddity Event äº‹ä»¶æ˜¯ä»¥å¤ªåŠè™šæ‹Ÿæœº(EVM)æ—¥å¿—åŸºç¡€è®¾æ–½æä¾›çš„ä¸€ä¸ªä¾¿åˆ©æ¥å£ã€‚å½“è¢«å‘é€äº‹ä»¶ï¼ˆè°ƒç”¨ï¼‰æ—¶ï¼Œä¼šè§¦å‘å‚æ•°å­˜å‚¨åˆ°äº¤æ˜“çš„æ—¥å¿—ä¸­ã€‚è¿™äº›æ—¥å¿—ä¸åˆçº¦çš„åœ°å€å…³è”ï¼Œå¹¶è®°å½•åˆ°åŒºå—é“¾ä¸­ã€‚æ¯ä¸ªäº¤æ˜“æ”¶æ®åŒ…å« 0 åˆ°å¤šä¸ª log è®°å½•ï¼Œlog è¡¨æ˜ç€æ™ºèƒ½åˆçº¦æ‰€è§¦å‘çš„äº‹ä»¶ã€‚

## 1ï¸âƒ£ Event è¯­æ³•

**äº‹ä»¶çš„å®šä¹‰**:ä½¿ç”¨ `event` å…³é”®å­—æ¥å®šä¹‰ä¸€ä¸ªäº‹ä»¶ Eventï¼Œè¯­æ³•å¦‚ä¸‹ï¼š

```
event EventName(<parameter list>);
```

**äº‹ä»¶çš„è§¦å‘**:åªèƒ½ä½¿ç”¨ `emit` å…³é”®å­—æ¥è§¦å‘äº‹ä»¶ Eventï¼Œè¯­æ³•å¦‚ä¸‹ï¼š

```
emit EventName(<parameter list>);
```

## 2ï¸âƒ£ å››ç§äº‹ä»¶å®šä¹‰æ–¹å¼

1. ä¸å¸¦å‚æ•°çš„ event
2. å¸¦å‚æ•°çš„ event
3. å¸¦å‚æ•°åçš„ event
4. å¸¦ indexed å‚æ•°åçš„ event
   1. è¿™ç§äº‹ä»¶ä¹Ÿè¢«ç§°ä¸º**ç´¢å¼•äº‹ä»¶**
   2. è¯­æ³•:`event EventName(TypeName indexed varibleName....);`
   3. äº‹ä»¶ä¸­ indexed æ ‡è®°è¿‡çš„å‚æ•°ï¼Œå¯ä»¥åœ¨é“¾å¤–è¿›è¡Œæœç´¢æŸ¥è¯¢ã€‚
   4. ä¸€ä¸ªäº‹ä»¶ä¸­ indexed æ ‡è®°è¿‡çš„å‚æ•°æœ€å¤šæœ‰ 3 ä¸ªã€‚

```
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.17;

contract Event {
    // æ™®é€š event
    event Log1(address, string);

    // å¸¦åå­—çš„ event
    event Log2(address ads, string msg);

    // å¸¦ indexed çš„event
    event Log3(address indexed ads, string msg);

    // indexed åœ¨ä¸€ä¸ªäº‹ä»¶å†…ä½¿ç”¨æ¬¡æ•°ä¸èƒ½è¶…è¿‡3æ¬¡
    event Transfer(
        address indexed from,
        address indexed to,
        uint256 indexed amount
    );

    function log1() external {
        emit Log1(msg.sender, "Log111");
    }

    function log2() external {
        emit Log2(msg.sender, "Log222");
    }

    function log3() external {
        emit Log3(msg.sender, "Log333");
    }

    function transfer(address _to, uint256 amount) external {
        emit Transfer(msg.sender, _to, amount);
    }
}
```

### 1 ä¸å¸¦å‚æ•°çš„ event

```json
[
	{
		"from": "0x7874d94b8f9E2a28FCceCE404666C984f33a82b8",
		"topic": "0x1732d0c17008d342618e7f03069177d8d39391d79811bb4e706d7c6c84108c0f",
		"event": "Log1",
		"args": {}
	}
]
```

### 2 å¸¦å‚æ•°çš„ event

```json
[
	{
		"from": "0x7874d94b8f9E2a28FCceCE404666C984f33a82b8",
		"topic": "0x54010eb0426bdddd13273086604fca7ba750a84093c6839732d954056646e81b",
		"event": "Log2",
		"args": {
			"0": "0x5B38Da6a701c568545dCfcB03FcB875f56beddC4",
			"1": "Log222"
		}
	}
]
```

### 3 å¸¦å‚æ•°åçš„ event

```json
[
	{
		"from": "0x7874d94b8f9E2a28FCceCE404666C984f33a82b8",
		"topic": "0x940879bf2d29cdfe8084f2f033d2168f5859a6e10530b61fb84dc1c5ddc9ca40",
		"event": "Log3",
		"args": {
			"0": "0x5B38Da6a701c568545dCfcB03FcB875f56beddC4",
			"1": "Log333",
			"ads": "0x5B38Da6a701c568545dCfcB03FcB875f56beddC4",
			"msg": "Log333"
		}
	}
]
```

### 4 å¸¦ indexed å‚æ•°åçš„ event

```json
[
	{
		"from": "0xfB72aAdB17a855D27A68B565ee0a84CB30A387e4",
		"topic": "0xf485c071883274befba21423da7f60203f9df753bf614bca26c4763ed4b240fb",
		"event": "Log4",
		"args": {
			"0": "0x5B38Da6a701c568545dCfcB03FcB875f56beddC4",
			"1": "Log444",
			"ads": "0x5B38Da6a701c568545dCfcB03FcB875f56beddC4",
			"msg": "Log444"
		}
	}
]
```

```json
[
	{
		"from": "0xfB72aAdB17a855D27A68B565ee0a84CB30A387e4",
		"topic": "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
		"event": "Transfer",
		"args": {
			"0": "0x5B38Da6a701c568545dCfcB03FcB875f56beddC4",
			"1": "0x5B38Da6a701c568545dCfcB03FcB875f56beddC4",
			"2": "1",
			"from": "0x5B38Da6a701c568545dCfcB03FcB875f56beddC4",
			"to": "0x5B38Da6a701c568545dCfcB03FcB875f56beddC4",
			"amount": "1"
		}
	}
]
```

## 3ï¸âƒ£ indexed çš„ä½œç”¨

indexed æ•°æ®ä¼šè¢«è®°å½•åˆ° `topics` ä¸­ï¼Œå¯ä»¥ç”¨äºæ£€ç´¢ã€‚å·²ç´¢å¼•çš„éƒ¨åˆ†ï¼Œæœ€å¤šæœ‰ 3 ä¸ªï¼ˆå¯¹äºéåŒ¿åäº‹ä»¶ï¼‰æˆ– 4 ä¸ªï¼ˆå¯¹äºåŒ¿åäº‹ä»¶ï¼‰

å¯¹äºéåŒ¿åäº‹ä»¶ï¼Œæœ€å¤šä¸‰ä¸ªå‚æ•°å¯ä»¥æ¥æ”¶ `indexed`å±æ€§ï¼ˆå®ƒæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„åä¸º: "ä¸»é¢˜" çš„æ•°æ®ç»“æ„ï¼Œè€Œä¸ä½œä¸ºæ—¥å¿—çš„æ•°æ®éƒ¨åˆ†ï¼‰ã€‚ä¸»é¢˜ä»…æœ‰ 32 å­—èŠ‚ï¼Œ å› æ­¤å¦‚æœ:å¼•ç”¨ç±»å‹ æ ‡è®°ä¸ºç´¢å¼•é¡¹ï¼Œåˆ™å®ƒä»¬çš„ keccak-256 å“ˆå¸Œå€¼ä¼šè¢«ä½œä¸º ä¸»é¢˜ï¼ˆtopicï¼‰ ä¿å­˜ã€‚

ä¸»é¢˜ï¼ˆtopicï¼‰è®©æˆ‘ä»¬å¯ä»¥å¯ä»¥æœç´¢äº‹ä»¶ï¼Œæ¯”å¦‚åœ¨ä¸ºæŸäº›äº‹ä»¶è¿‡æ»¤ä¸€äº›åŒºå—ï¼Œè¿˜å¯ä»¥æŒ‰å‘èµ·äº‹ä»¶çš„åˆåŒåœ°å€æ¥è¿‡æ»¤äº‹ä»¶ã€‚

ä¾‹å¦‚, ä½¿ç”¨å¦‚ä¸‹çš„ web3.js `subscribe("logs")æ–¹æ³•` å»è¿‡æ»¤ç¬¦åˆç‰¹å®šåœ°å€çš„ ä¸»é¢˜ï¼ˆtopicï¼‰ ï¼š

```js
var options = {
	fromBlock: 0,
	address: web3.eth.defaultAccount,
	topics: ["0x0000000000000000000000000000000000000000000000000000000000000000", null, null],
};
web3.eth
	.subscribe("logs", options, function (error, result) {
		if (!error) console.log(result);
	})
	.on("data", function (log) {
		console.log(log);
	})
	.on("changed", function (log) {});
```

ä¸»è¦ç”¨åœ¨é“¾ä¸‹æœåŠ¡ï¼Œå¯ä»¥é€šè¿‡ RPC è·å–ï¼Œæ¯”å¦‚ web3 çš„ä»¥ä¸‹æ–¹æ³•:

- `myContract.once`
  - https://web3js.readthedocs.io/en/v1.7.5/web3-eth-contract.html
- `myContract.events.MyEvent`
  - https://web3js.readthedocs.io/en/v1.7.5/web3-eth-contract.html#contract-events
- `myContract.getPastEvents`
  - https://web3js.readthedocs.io/en/v1.7.5/web3-eth-contract.html#getpastevents

## 4ï¸âƒ£ log çš„ä½¿ç”¨

é™¤éä½ ç”¨ `anonymous` å£°æ˜äº‹ä»¶ï¼Œå¦åˆ™äº‹ä»¶ç­¾åçš„å“ˆå¸Œå€¼æ˜¯ä¸€ä¸ª ä¸»é¢˜ï¼ˆtopicï¼‰ã€‚åŒæ—¶ä¹Ÿæ„å‘³ç€å¯¹äºåŒ¿åäº‹ä»¶æ— æ³•é€šè¿‡åå­—æ¥è¿‡æ»¤ï¼Œä»…èƒ½æŒ‰åˆçº¦åœ°å€è¿‡æ»¤ã€‚åŒ¿åäº‹ä»¶çš„ä¼˜åŠ¿æ˜¯ä»–ä»¬éƒ¨ç½²å’Œè°ƒç”¨çš„æˆæœ¬æ›´ä½ã€‚å®ƒä¹Ÿå…è®¸ä½ å£°æ˜ 4 ä¸ªç´¢å¼•å‚ä¸è€Œä¸æ˜¯ 3 ä¸ªã€‚

âš ï¸ï¼šç”±äºäº¤æ˜“æ—¥å¿—åªå­˜å‚¨äº‹ä»¶æ•°æ®è€Œä¸å­˜å‚¨ç±»å‹ã€‚ä½ å¿…é¡»çŸ¥é“äº‹ä»¶çš„ç±»å‹ï¼ŒåŒ…æ‹¬å“ªä¸ªå‚æ•°è¢«ç´¢å¼•ï¼Œä»¥åŠè¯¥äº‹ä»¶æ˜¯å¦æ˜¯åŒ¿åçš„ï¼Œä»¥ä¾¿æ­£ç¡®è§£é‡Šæ•°æ®ã€‚å°¤å…¶æ˜¯ï¼Œæœ‰å¯èƒ½ä½¿ç”¨ä¸€ä¸ªåŒ¿åäº‹ä»¶æ¥"ä¼ªé€ "å¦ä¸€ä¸ªäº‹ä»¶çš„ç­¾åã€‚

```
pragma solidity  >=0.4.21 <0.9.0;

contract ClientReceipt {
    event Deposit(
        address indexed from,
        bytes32 indexed id,
        uint value
    );

    function deposit(bytes32 id) public payable {
        // äº‹ä»¶ä½¿ç”¨ emit è§¦å‘äº‹ä»¶ã€‚
        // æˆ‘ä»¬å¯ä»¥è¿‡æ»¤å¯¹ `Deposit` çš„è°ƒç”¨ï¼Œä»è€Œç”¨ Javascript API æ¥æŸ¥æ˜å¯¹è¿™ä¸ªå‡½æ•°çš„ä»»ä½•è°ƒç”¨ï¼ˆç”šè‡³æ˜¯æ·±åº¦åµŒå¥—è°ƒç”¨ï¼‰ã€‚
        emit Deposit(msg.sender, id, msg.value);
    }
}
```

ä½¿ç”¨ JavaScript API è°ƒç”¨äº‹ä»¶çš„ç”¨æ³•å¦‚ä¸‹ï¼š

```javascript
var abi = /* abi ç”±ç¼–è¯‘å™¨äº§ç”Ÿ */;
var ClientReceipt = web3.eth.contract(abi);
var clientReceipt = ClientReceipt.at("0x1234...xlb67" /* åœ°å€ */);

var depositEvent = clientReceipt.Deposit();

// ç›‘å¬å˜åŒ–
depositEvent.watch(function(error, result) {
    // ç»“æœåŒ…å« éç´¢å¼•å‚æ•° ä»¥åŠ ä¸»é¢˜ topic
    if (!error)
        console.log(result);
});

// æˆ–è€…é€šè¿‡ä¼ å…¥å›è°ƒå‡½æ•°ï¼Œç«‹å³å¼€å§‹å¬ç›‘
var depositEvent = clientReceipt.Deposit(function(error, result) {
    if (!error)
        console.log(result);
});
```

ä¸Šé¢çš„è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼ˆæœ‰åˆ å‡ï¼‰ï¼š

```json
{
	"returnValues": {
		"from": "0x1111â€¦FFFFCCCC",
		"id": "0x50â€¦sd5adb20",
		"value": "0x420042"
	},
	"raw": {
		"data": "0x7fâ€¦91385",
		"topics": ["0xfd4â€¦b4ead7", "0x7fâ€¦1a91385"]
	}
}
```

## 5ï¸âƒ£ Log é‡è½½

Log å¯ä»¥åƒå‡½æ•°ä¸€æ ·é‡è½½

```
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.17;

contract Event {
    event Log(address ads);
    event Log(address indexed ads, string msg); // é‡è½½

    function log1() external {
        emit Log(msg.sender);
    }

    function log2() external {
        emit Log(msg.sender, "Log111");
    }
}
```

## ğŸ†— å®æˆ˜: ä¼—ç­¹åˆçº¦

### åˆçº¦ä»£ç 

```
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.17;

contract Croedfund {
    /* ============ Type Declaration ============ */
    // å‡ºèµ„äººè§’è‰²
    // * ä»…éœ€è®°å½•åœ°å€/é‡‘é¢å³å¯
    struct Donor {
        address addr; //å‡ºèµ„äººåœ°å€
        uint256 amount; //å‡ºèµ„äººé‡‘é¢
    }

    // å‹Ÿèµ„äººè§’è‰²
    // * ç”¨äºè¡¨ç¤ºä¸€ä¸ªå‹Ÿèµ„é¡¹ç›®ï¼Œå…¶ä¸­åŒ…æ‹¬å‹Ÿèµ„äººåœ°å€ã€ç›®æ ‡é‡‘é¢ã€
    // å·²ç­¹é›†é‡‘é¢ã€æèµ è€…äººæ•°ã€é¡¹ç›®çŠ¶æ€ä»¥åŠæ‰€æœ‰çš„å‡ºèµ„äººã€‚
    struct Donee {
        address creator; // å‹Ÿèµ„äººåœ°å€
        uint256 goal; // ä¼—ç­¹ç›®æ ‡æ•°é‡
        uint32 startAt; // å¼€å§‹æ—¶é—´
        uint32 endAt; // ç»“æŸæ—¶é—´
        bool claimed; // æ˜¯å¦è¢«é¢†å–
        uint256 amount; // å·²ç­¹é›†é‡‘é¢
        uint256 donorCount; // * æèµ è€…äººæ•°
        mapping(uint256 => Donor) donorMap; // * å‡ºèµ„äººå­—å…¸
    }

    /* ============ State Variables ============ */
    address payable owner; //åˆçº¦æ‹¥æœ‰è€…
    uint256 public doneeCount; // å‹Ÿèµ„äººæ•°é‡
    mapping(uint256 => Donee) public doneeMap; //å‹Ÿèµ„äººå­—å…¸

    /* ============ Events ============ */
    event Launch(
        uint256 id,
        address indexed creator,
        uint256 goal,
        uint32 startAt,
        uint32 endAt
    );
    event Cancel(uint256 id);
    event Donate(uint256 indexed id, address indexed caller, uint256 amount);
    event Unpledge(uint256 indexed id, address indexed caller, uint256 amount);
    event Claim(uint256 id, address creator, uint256 amount);
    event Refund(uint256 indexed id, address indexed caller, uint256 amount);

    /* ============ Modifier ============ */
    modifier onlyOwner() {
        require(msg.sender == owner, "only owner");
        _;
    }
    // éªŒè¯å‹Ÿææ´»åŠ¨IDæ˜¯å¦æœ‰æ•ˆ
    modifier validDonee(uint256 doneeID) {
        require(doneeID > 0 && doneeID <= doneeCount);
        _;
    }

    /* ============ Errors ============ */
    error MyError(string);

    /* ============ Constructor ============ */
    constructor() {
        owner = payable(msg.sender);
    }

    /* ============ Functions ============ */
    // å¯åŠ¨æ–°ä¼—ç­¹
    function launch(
        address _addr,
        uint256 _goal,
        uint32 _startAt,
        uint32 _endAt
    ) external onlyOwner {
        require(_startAt >= block.timestamp, "start at < now");
        require(_startAt <= _endAt, "start at > end at");
        require(_endAt <= block.timestamp + 30 days, "end at > max duration");

        doneeCount++;

        Donee storage donee = doneeMap[doneeCount];
        donee.creator = _addr;
        donee.goal = _goal;
        donee.startAt = _startAt;
        donee.endAt = _endAt;
        emit Launch(doneeCount, msg.sender, _goal, _startAt, _endAt);
    }

    // å–æ¶ˆæŒ‡å®šIDçš„ä¼—ç­¹
    function cancel(uint256 _id) external onlyOwner {
        // ä¸éœ€è¦ä¿®æ”¹ï¼Œéœ€ç”¨ memeory ,ä½†æ˜¯åŒ…å«mappingç±»å‹ï¼Œæ‰€ä»¥éœ€è¦ç”¨ storage
        Donee storage campaign = doneeMap[_id];
        require(block.timestamp < campaign.startAt, "started"); // å¿…é¡»è¿˜æ²¡æœ‰å¼€å§‹
        delete doneeMap[_id];
        emit Cancel(_id);
    }

    // å‡ºèµ„äººæèµ 
    function donate(uint256 _id) external payable validDonee(_id) {
        Donee storage donee = doneeMap[_id]; // éœ€è¦ä¿®æ”¹ï¼Œæ‰€ä»¥ä½¿ç”¨ storage
        require(block.timestamp >= donee.startAt, "not start"); //
        require(block.timestamp <= donee.endAt, "ended"); //

        donee.donorCount++;
        donee.amount += msg.value;

        Donor storage donor = donee.donorMap[donee.donorCount];
        donor.addr = msg.sender;
        donor.amount = msg.value;

        emit Donate(_id, msg.sender, msg.value);
    }

    // å®Œæˆç›®æ ‡ç»™å‹Ÿèµ„äººè½¬è´¦
    function transfer(uint256 doneeID) public onlyOwner validDonee(doneeID) {
        Donee storage donee = doneeMap[doneeID];

        require(!donee.claimed, "is claimed");
        require(block.timestamp >= donee.endAt, "not ended");
        require(donee.amount >= donee.goal, "amount < goal");

        // è®¾ç½®å·²ç»æ”¯ä»˜çš„çŠ¶æ€
        donee.claimed = true;

        // ç»™å‹Ÿèµ„äººè½¬è´¦
        payable(donee.creator).transfer(donee.goal);
        emit Claim(doneeID, msg.sender, donee.amount);
    }

    /* ============ Helper ============ */
    fallback() external {}

    receive() external payable {}

    // è·å–å½“å‰åˆçº¦çš„ä½™é¢
    function getBalance() public view returns (uint256) {
        return address(this).balance;
    }

    // åˆçº¦çš„ä½™é¢è½¬è´¦åˆ°æ‹¥æœ‰è€…
    function withdraw(uint256 doneeID) public onlyOwner {
        Donee storage donee = doneeMap[doneeID];
        require(donee.claimed, "not claimed");
        require(block.timestamp >= donee.endAt, "not ended");

        payable(msg.sender).transfer(address(this).balance);
    }

    // è·å–é¡¹ç›®çŠ¶æ€
    function getStatus(uint256 doneeID)
        public
        view
        validDonee(doneeID)
        returns (bool)
    {
        Donee storage donee = doneeMap[doneeID];
        return (block.timestamp >= donee.startAt &&
            block.timestamp <= donee.endAt);
    }
}
```

### æµ‹è¯•åˆçº¦

- address1 launch ä¸€æ¬¡æ´»åŠ¨
  - goal ä¸º 10
  - æ—¶é—´æˆ³è·å–: <https://tool.chinaz.com/tools/unixtime.aspx>
- doneeMap æŸ¥è¯¢ id 1 ä¿¡æ¯
- getStatus æŸ¥è¯¢ id 1 æ˜¯å¦å¼€å§‹
- address2 donate 6
- address3 donate 7
- doneeMap æŸ¥è¯¢ id 1 ä¿¡æ¯
