# 17.metadata:å…ƒæ•°æ®

Solidity ç¼–è¯‘å™¨åœ¨ç¼–è¯‘çš„æ—¶å€™è‡ªåŠ¨ç”Ÿæˆ`xx_metadata.json`çš„ JSON æ–‡ä»¶ï¼Œä¸­æ–‡å«åˆçº¦çš„å…ƒæ•°æ®ï¼Œå…¶ä¸­åŒ…å«äº†å½“å‰åˆçº¦çš„ç›¸å…³ä¿¡æ¯ã€‚

## 1ï¸âƒ£ metadata åŒ…å«ä¿¡æ¯

å…ƒæ•°æ®æ–‡ä»¶å…·æœ‰ä»¥ä¸‹æ ¼å¼ã€‚ ä¸‹é¢çš„ä¾‹å­å°†ä»¥äººç±»å¯è¯»çš„æ–¹å¼å‘ˆç°ã€‚æ­£ç¡®æ ¼å¼åŒ–çš„å…ƒæ•°æ®åº”æ­£ç¡®ä½¿ç”¨å¼•å·ï¼Œå°†ç©ºç™½å‡å°‘åˆ°æœ€å°ï¼Œå¹¶å¯¹æ‰€æœ‰å¯¹è±¡çš„é”®å€¼è¿›è¡Œæ’åºä»¥å¾—åˆ°å”¯ä¸€çš„æ ¼å¼ã€‚ï¼ˆä¸‹é¢çš„ä»£ç æ³¨é‡Šæ˜¯ä¸å…è®¸çš„ï¼Œè¿™é‡Œä»…ç”¨äºè§£é‡Šç›®çš„ã€‚ï¼‰

```json
{
  // å¿…é€‰ï¼šå…ƒæ•°æ®æ ¼å¼çš„ç‰ˆæœ¬(æ³¨æ„å’ŒSolidityç‰ˆæœ¬ä¸æ˜¯åŒä¸€ä¸ªversion )
  "version": "1",

  // å¿…é€‰ï¼šæºä»£ç çš„ç¼–ç¨‹è¯­è¨€ï¼Œä¸€èˆ¬ä¼šé€‰æ‹©è§„èŒƒçš„â€œå­ç‰ˆæœ¬â€
  "language": "Solidity",

  // å¿…é€‰ï¼šç¼–è¯‘å™¨çš„ç»†èŠ‚ï¼Œå†…å®¹è§†è¯­è¨€è€Œå®šã€‚
  "compiler": {
    // å¯¹ Solidity æ¥è¯´æ˜¯å¿…é¡»çš„ï¼šç¼–è¯‘å™¨çš„ç‰ˆæœ¬
    "version": "0.8.7+commit.e28d00a7",
    // å¯é€‰ï¼š ç”Ÿæˆæ­¤è¾“å‡ºçš„ç¼–è¯‘å™¨äºŒè¿›åˆ¶æ–‡ä»¶çš„å“ˆå¸Œå€¼
    "keccak256": "0x123..."
  },

  // å¿…é€‰ï¼šåˆçº¦çš„ç”Ÿæˆä¿¡æ¯
  "output": {
    // å¿…é€‰ï¼šåˆçº¦çš„ ABI å®šä¹‰
    "abi": [ /*...*/],
    // å¿…é€‰ï¼šåˆçº¦çš„ NatSpec ç”¨æˆ·æ–‡æ¡£
    "userdoc": [ /*...*/],
    // å¿…é€‰ï¼šåˆçº¦çš„ NatSpec å¼€å‘è€…æ–‡æ¡£
    "devdoc": [ /*...*/],
  },

  // å¿…é€‰ï¼šç¼–è¯‘å™¨çš„è®¾ç½®
  "settings": {
    "compilationTarget": {
      "a.sol": "Sum"
    },
    "evmVersion": "london",
    "libraries": {},
    "metadata": {
      // Reflects the setting used in the input json, defaults to false
      "useLiteralContent": true,
      // Reflects the setting used in the input json, defaults to "ipfs"
      "bytecodeHash": "ipfs"
    },
    // å¯é€‰ï¼š ä¼˜åŒ–å™¨çš„è®¾ç½®ï¼ˆ enabled é»˜è®¤è®¾ä¸º false ï¼‰
    "optimizer": {
      "enabled": true,
      "runs": 200
    },
    // å¯¹ Solidity æ¥è¯´æ˜¯å¿…é¡»çš„ï¼š å·²æ’åºçš„é‡å®šå‘åˆ—è¡¨
    "remappings": [":g/dir"],
  },

  // å¿…é€‰ï¼šç¼–è¯‘çš„æºæ–‡ä»¶ï¼æºå•ä½ï¼Œé”®å€¼ä¸ºæ–‡ä»¶å
  "sources": {
    "myFile.sol": {
      // å¿…é€‰ï¼šæºæ–‡ä»¶çš„ keccak256 å“ˆå¸Œå€¼
      "keccak256": "0x123...",

      // Optional: åœ¨æºæ–‡ä»¶ä¸­å®šä¹‰çš„ SPDX license æ ‡è¯†
      "license": "MIT",
      // å¿…é€‰ï¼ˆé™¤éå®šä¹‰äº† contentï¼Œè¯¦è§ä¸‹æ–‡ï¼‰ï¼š
      // å·²æ’åºçš„æºæ–‡ä»¶çš„URLï¼ŒURLçš„åè®®å¯ä»¥æ˜¯ä»»æ„çš„ï¼Œä½†å»ºè®®ä½¿ç”¨ Swarm çš„URL
      "urls": [
        "bzz-raw://fd33d...",
        "dweb:/ipfs/Qme8Vrt"
      ]
    },
    // å¯é€‰
    "mortal": {
      // å¿…é€‰ï¼šæºæ–‡ä»¶çš„ keccak256 å“ˆå¸Œå€¼
      "keccak256": "0x234...",
      // å¿…é€‰ï¼ˆé™¤éå®šä¹‰äº†â€œurlsâ€ï¼‰ï¼š æºæ–‡ä»¶çš„å­—é¢å†…å®¹
      "content": "contract mortal is owned { function kill() { 
        if (msg.sender == owner) selfdestruct(owner); } }"
    }
  },
}
```

### metadata çš„ä½œç”¨

metadata ä¸»è¦æ˜¯ä¸ºäº†æ›´å®‰å…¨åœ°ä¸åˆçº¦è¿›è¡Œäº¤äº’å¹¶éªŒè¯å…¶æºä»£ç ã€‚

- æŸ¥è¯¢ç¼–è¯‘å™¨ç‰ˆæœ¬
- æ‰€ä½¿ç”¨çš„æºä»£ç 
- ABI
- natspec æ–‡æ¡£

ç¼–è¯‘å™¨ä¼šå°†å…ƒæ•°æ®æ–‡ä»¶çš„ Swarm å“ˆå¸Œå€¼é™„åŠ åˆ°æ¯ä¸ªåˆçº¦çš„å­—èŠ‚ç æœ«å°¾ï¼ˆè¯¦æƒ…è¯·å‚é˜…ä¸‹æ–‡ï¼‰ï¼Œä»¥ä¾¿ä½ å¯ä»¥ä»¥è®¤è¯çš„æ–¹å¼è·å–è¯¥æ–‡ä»¶ï¼Œè€Œä¸å¿…æ±‚åŠ©äºä¸­å¿ƒåŒ–çš„æ•°æ®æä¾›è€…ã€‚å½“ç„¶ï¼Œä½ å¿…é¡»å°†å…ƒæ•°æ®æ–‡ä»¶å‘å¸ƒåˆ° Swarmï¼ˆæˆ–å…¶ä»–æœåŠ¡ï¼‰ï¼Œä»¥ä¾¿å…¶ä»–äººå¯ä»¥è®¿é—®å®ƒã€‚ è¯¥æ–‡ä»¶å¯ä»¥é€šè¿‡ä½¿ç”¨`solc --metadata` æ¥ç”Ÿæˆï¼Œå¹¶è¢«å‘½åä¸º `ContractName_meta.json` ã€‚ å®ƒå°†åŒ…å«æºä»£ç çš„åœ¨ Swarm ä¸Šçš„å¼•ç”¨ï¼Œå› æ­¤ä½ å¿…é¡»ä¸Šä¼ æ‰€æœ‰æºæ–‡ä»¶å’Œå…ƒæ•°æ®æ–‡ä»¶ã€‚

----

âš ï¸è­¦å‘Š: ç”±äºç”Ÿæˆçš„åˆçº¦çš„å­—èŠ‚ç åŒ…å«å…ƒæ•°æ®çš„å“ˆå¸Œå€¼ï¼Œå› æ­¤å¯¹å…ƒæ•°æ®çš„ä»»ä½•æ›´æ”¹éƒ½ä¼šå¯¼è‡´å­—èŠ‚ç çš„æ›´æ”¹ã€‚
æ­¤å¤–ï¼Œç”±äºå…ƒæ•°æ®åŒ…å«æ‰€æœ‰ä½¿ç”¨çš„æºä»£ç çš„å“ˆå¸Œå€¼ï¼Œæ‰€ä»¥ä»»ä½•æºä»£ç ä¸­çš„ï¼Œå“ªæ€•æ˜¯ä¸€ä¸ªç©ºæ ¼çš„å˜åŒ–éƒ½å°†å¯¼è‡´ä¸åŒçš„å…ƒæ•°æ®ï¼Œå¹¶éšåäº§ç”Ÿä¸åŒçš„å­—èŠ‚ä»£ç ã€‚

âš ï¸è­¦å‘Š:  éœ€æ³¨æ„ï¼Œä¸Šé¢çš„ ABI æ²¡æœ‰å›ºå®šçš„é¡ºåºï¼Œéšç¼–è¯‘å™¨çš„ç‰ˆæœ¬è€Œä¸åŒã€‚

## 2ï¸âƒ£ å­—èŠ‚ç ä¸­å…ƒæ•°æ®å“ˆå¸Œçš„ç¼–ç 

ç”±äºåœ¨å°†æ¥å¯èƒ½ä¼šæ”¯æŒå…¶ä»–æ–¹å¼æ¥è·å–å…ƒæ•°æ®æ–‡ä»¶ï¼Œ ç±»ä¼¼`{"bzzr0"ï¼š<Swarm hash>}` çš„é”®å€¼å¯¹ï¼Œå°†ä¼šä»¥
[CBOR](https://tools.ietf.org/html/rfc7049) ç¼–ç æ¥å­˜å‚¨ã€‚ç”±äºè¿™ç§ç¼–ç çš„èµ·å§‹ä½ä¸å®¹æ˜“æ‰¾åˆ°ï¼Œå› æ­¤æ·»åŠ ä¸¤ä¸ªå­—èŠ‚æ¥è¡¨è¿°å…¶é•¿åº¦ï¼Œä»¥å¤§ç«¯æ–¹å¼ç¼–ç ã€‚æ‰€ä»¥ï¼Œå½“å‰ç‰ˆæœ¬çš„ Solidity ç¼–è¯‘å™¨ï¼Œå°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°éƒ¨ç½²çš„å­—èŠ‚ç çš„æœ«å°¾

```
    0xa2
    0x64 'i' 'p' 'f' 's' 0x58 0x22 <34 bytes IPFS hash>
    0x64 's' 'o' 'l' 'c' 0x43 <3 byte version encoding>
    0x00 0x33
```

So in order to retrieve the data, the end of the deployed bytecode can
be checked to match that pattern and use the IPFS hash to retrieve the
file.

Whereas release builds of solc use a 3 byte encoding of the version as
shown above (one byte each for major, minor and patch version number),
prerelease builds will instead use a complete version string including
commit hash and build date.

.. note:: The CBOR mapping can also contain other keys, so it is better
to fully decode the data instead of relying on it starting with
`0xa264`. For example, if any experimental features that affect code
generation are used, the mapping will also contain
`"experimental": true`.

.. note:: The compiler currently uses the IPFS hash of the metadata by
default, but it may also use the bzzr1 hash or some other hash in the
future, so do not rely on this sequence to start with
`0xa2 0x64 'i' 'p' 'f' 's'`. We might also add additional data to this
CBOR structure, so the best option is to use a proper CBOR parser.

## 3ï¸âƒ£ è‡ªåŠ¨åŒ–æ¥å£ç”Ÿæˆå’Œ natspec ä½¿ç”¨

The metadata is used in the following way: A component that wants to
interact with a contract (e.g. Mist or any wallet) retrieves the code of
the contract, from that the IPFS/Swarm hash of a file which is then
retrieved. That file is JSON-decoded into a structure like above.

The component can then use the ABI to automatically generate a
rudimentary user interface for the contract.

Furthermore, the wallet can use the NatSpec user documentation to
display a confirmation message to the user whenever they interact with
the contract, together with requesting authorization for the transaction
signature.

## 4ï¸âƒ£ æºä»£ç å¦‚ä½•éªŒè¯ï¼Ÿ

ä¸ºäº†éªŒè¯ç¼–è¯‘ï¼Œå¯ä»¥é€šè¿‡å…ƒæ•°æ®æ–‡ä»¶ä¸­çš„é“¾æ¥ä» IPFS/Swarm ä¸­è·å–æºä»£ç ã€‚è·å–åˆ°çš„æºç ï¼Œä¼šæ ¹æ®å…ƒæ•°æ®ä¸­æŒ‡å®šçš„è®¾ç½®ï¼Œè¢«æ­£ç¡®ç‰ˆæœ¬çš„ç¼–è¯‘å™¨æ‰€å¤„ç†ã€‚å¤„ç†å¾—åˆ°çš„å­—èŠ‚ç ä¼šä¸åˆ›å»ºäº¤æ˜“çš„æ•°æ®æˆ–è€… `CREATE` æ“ä½œç ä½¿ç”¨çš„æ•°æ®è¿›è¡Œæ¯”è¾ƒã€‚è¿™ä¼šè‡ªåŠ¨éªŒè¯å…ƒæ•°æ®ï¼Œå› ä¸ºå®ƒçš„å“ˆå¸Œå€¼æ˜¯å­—èŠ‚ç çš„ä¸€éƒ¨åˆ†ã€‚è€Œé¢å¤–çš„æ•°æ®ï¼Œåˆ™æ˜¯ä¸åŸºäºæ¥å£è¿›è¡Œç¼–ç å¹¶å±•ç¤ºç»™ç”¨æˆ·çš„æ„é€ è¾“å…¥æ•°æ®ç›¸ç¬¦çš„ã€‚

åœ¨ [sourcify](https://github.com/ethereum/sourcify) åº“([npm package](https://www.npmjs.com/package/source-verify))å¯ä»¥çœ‹åˆ°å¦‚ä½•ä½¿ç”¨è¯¥ç‰¹æ€§çš„ç¤ºä¾‹ä»£ç ã€‚

## ğŸ†— å®æˆ˜åº”ç”¨

## #ï¸âƒ£ é—®ç­”é¢˜

- metadata çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ
  - metadata ä¸»è¦æ˜¯ä¸ºäº†æ›´å®‰å…¨åœ°ä¸åˆçº¦è¿›è¡Œäº¤äº’å¹¶éªŒè¯å…¶æºä»£ç ã€‚
  - æŸ¥è¯¢ç¼–è¯‘å™¨ç‰ˆæœ¬
  - æ‰€ä½¿ç”¨çš„æºä»£ç 
  - ABI
  - natspec æ–‡æ¡£
- metadata å†…å®¹æœ‰å“ªäº›ï¼Ÿ
  ```
  {
    // å¿…é€‰ï¼šå…ƒæ•°æ®æ ¼å¼çš„ç‰ˆæœ¬(æ³¨æ„å’ŒSolidityç‰ˆæœ¬ä¸æ˜¯åŒä¸€ä¸ªversion )
    "version": "1",

    // å¿…é€‰ï¼šæºä»£ç çš„ç¼–ç¨‹è¯­è¨€ï¼Œä¸€èˆ¬ä¼šé€‰æ‹©è§„èŒƒçš„â€œå­ç‰ˆæœ¬â€
    "language": "Solidity",

    // å¿…é€‰ï¼šç¼–è¯‘å™¨çš„ç»†èŠ‚ï¼Œå†…å®¹è§†è¯­è¨€è€Œå®šã€‚
    "compiler": {
      // å¯¹ Solidity æ¥è¯´æ˜¯å¿…é¡»çš„ï¼šç¼–è¯‘å™¨çš„ç‰ˆæœ¬
      "version": "0.8.7+commit.e28d00a7",
    },

    // å¿…é€‰ï¼šåˆçº¦çš„ç”Ÿæˆä¿¡æ¯
    "output": {
      // å¿…é€‰ï¼šåˆçº¦çš„ ABI å®šä¹‰
      "abi": [ /*...*/],
      // å¿…é€‰ï¼šåˆçº¦çš„ NatSpec ç”¨æˆ·æ–‡æ¡£
      "userdoc": [ /*...*/],
      // å¿…é€‰ï¼šåˆçº¦çš„ NatSpec å¼€å‘è€…æ–‡æ¡£
      "devdoc": [ /*...*/],
    },

    // å¿…é€‰ï¼šç¼–è¯‘å™¨çš„è®¾ç½®
    "settings": {},

    // å¿…é€‰ï¼šç¼–è¯‘çš„æºæ–‡ä»¶ï¼æºå•ä½ï¼Œé”®å€¼ä¸ºæ–‡ä»¶å
    "sources": {
      "myFile.sol": {
        // å¿…é€‰ï¼šæºæ–‡ä»¶çš„ keccak256 å“ˆå¸Œå€¼
        "keccak256": "0x123...",

        // Optional: åœ¨æºæ–‡ä»¶ä¸­å®šä¹‰çš„ SPDX license æ ‡è¯†
        "license": "MIT",
      }
    },
  }
  ```
- natspec å¦‚ä½•ä½¿ç”¨ï¼Ÿ
- æºä»£ç å¦‚ä½•éªŒè¯ï¼Ÿ
  - ä¸ºäº†éªŒè¯ç¼–è¯‘ï¼Œå¯ä»¥é€šè¿‡å…ƒæ•°æ®æ–‡ä»¶ä¸­çš„é“¾æ¥ä» IPFS/Swarm ä¸­è·å–æºä»£ç ã€‚è·å–åˆ°çš„æºç ï¼Œä¼šæ ¹æ®å…ƒæ•°æ®ä¸­æŒ‡å®šçš„è®¾ç½®ï¼Œè¢«æ­£ç¡®ç‰ˆæœ¬çš„ç¼–è¯‘å™¨æ‰€å¤„ç†ã€‚å¤„ç†å¾—åˆ°çš„å­—èŠ‚ç ä¼šä¸åˆ›å»ºäº¤æ˜“çš„æ•°æ®æˆ–è€… `CREATE` æ“ä½œç ä½¿ç”¨çš„æ•°æ®è¿›è¡Œæ¯”è¾ƒã€‚è¿™ä¼šè‡ªåŠ¨éªŒè¯å…ƒæ•°æ®ï¼Œå› ä¸ºå®ƒçš„å“ˆå¸Œå€¼æ˜¯å­—èŠ‚ç çš„ä¸€éƒ¨åˆ†ã€‚è€Œé¢å¤–çš„æ•°æ®ï¼Œåˆ™æ˜¯ä¸åŸºäºæ¥å£è¿›è¡Œç¼–ç å¹¶å±•ç¤ºç»™ç”¨æˆ·çš„æ„é€ è¾“å…¥æ•°æ®ç›¸ç¬¦çš„ã€‚
  - åœ¨ [sourcify](https://github.com/ethereum/sourcify) åº“([npm package](https://www.npmjs.com/package/source-verify))å¯ä»¥çœ‹åˆ°å¦‚ä½•ä½¿ç”¨è¯¥ç‰¹æ€§çš„ç¤ºä¾‹ä»£ç ã€‚